<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password</title>
</head>
<body>
  <h1>Set a new password</h1>

  <label>
    New password
    <input id="pw" type="password" />
  </label>
  <button id="setPw">Update password</button>

  <p id="msg"></p>

  <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://lldpkdwbnlqfuwjbbirt.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const msg = document.getElementById("msg");
  const pw = document.getElementById("pw");
  const btn = document.getElementById("setPw");

  function log(...a){ console.log("[reset]", ...a); }

  // 1) Turn the recovery link into an authenticated session
  try {
    const { data, error } = await supabase.auth.exchangeCodeForSession(window.location.href);
    log("exchangeCodeForSession", { hasSession: !!data?.session, error: error?.message });

    if (error) {
      msg.textContent = "This reset link is invalid or expired. Please request a new one.";
    } else {
      msg.textContent = "Link verified. Enter a new password.";
    }
  } catch (e) {
    log("exchangeCodeForSession threw", e);
    msg.textContent = "Could not verify reset link. Please request a new one.";
  }

  // 2) Update password for the user tied to that recovery session
  btn.addEventListener("click", async () => {
    const newPw = pw.value.trim();
    if (!newPw) return;

    btn.disabled = true;
    msg.textContent = "Updating passwordâ€¦";

    const { data, error } = await supabase.auth.updateUser({ password: newPw });

    log("updateUser", { ok: !error, error: error?.message });

    if (error) {
      msg.textContent = "Error updating password: " + error.message;
      btn.disabled = false;
      return;
    }

    msg.textContent = "Password updated! You can return to the app and log in.";
  });
</script>
</body>
</html>
